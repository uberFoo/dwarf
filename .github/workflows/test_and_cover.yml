name: Test and Coverage

on:
    workflow_dispatch:
    push:
        branches:
            - develop
            - master

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2
              with:
                  ref: develop
            - name: Set up Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
            # - name: Download grcov
            # run: |
            # curl -L https://github.com/mozilla/grcov/releases/download/v0.8.18/grcov-x86_64-unknown-linux-gnu.tar.bz2 | tar jxf -
            # sudo mv grcov /usr/local/bin/
            # - name: Install llvm-tools-preview
            # run: rustup component add llvm-tools-preview
            - name: Install cargo-llvm-cov
              uses: taiki-e/install-action@cargo-llvm-cov
            - name: Build plug-ins
              run: |
                  cd plug-ins/merlin
                  cargo build
                  cd ../sarzak
                  cargo build
                  cd ../..
            - name: Build and run tests with coverage
              run: |
                  TRACY_NO_INVARIANT_CHECK=1 cargo llvm-cov --lcov --output-path coverage.lcov --no-default-features --features "single-vec, repl"
              # run: sudo apt-get install lcov
            # - name: Install lcov
            # - name: Install lcov_cobertura
            # run: pip install lcov_cobertura
            # - name: Generate coverage report
            # run: |
            # lcov --summary coverage.lcov
            # lcov_cobertura coverage.lcov --output coverage.xml
            # env:
            # CI: true
            - name: Upload coverage reports to Codecov
              uses: codecov/codecov-action@v3
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
              with:
                  directory: ./
                  fail_ci_if_error: true
                  # files: ./coverage.xml
                  files: coverage.lcov
                  flags: unittests
                  name: codecov-umbrella
                  verbose: true
